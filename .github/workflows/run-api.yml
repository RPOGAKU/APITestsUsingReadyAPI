name: Run ReadyAPI Tests

on:
  workflow_dispatch:

permissions:
  checks: write
  contents: read

jobs:
  run-tests:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Create reports directory with open permissions
        run: |
          mkdir -p ${{ github.workspace }}/reports
          chmod 777 ${{ github.workspace }}/reports

      - name: Run ReadyAPI tests via Docker
        run: |
          echo "ğŸ“‚ Listing files in workspace:"
          ls -la "${{ github.workspace }}"
      
          echo "SLM_LICENSE_SERVER=${{ secrets.SLM_LICENSE_SERVER }}" > .env
          echo "API_KEY=${{ secrets.SLM_API_KEY }}" >> .env
          echo "COMMAND_LINE=-Esandbox -sDemoAppProject -cTestScenarios -RJUnit -j -f/project/reports /project/DemoAppProject.xml" >> .env
      
          docker pull smartbear/ready-api-soapui-testrunner
      
          docker run --env-file .env -v "${{ github.workspace }}:/project" smartbear/ready-api-soapui-testrunner

      - name: Debug Report Directory
        run: |
          echo "ğŸ“ Contents of reports directory:"
          ls -la ./reports

      - name: Display JUnit Test Summary in CLI
        run: |
          echo "ğŸ“Š Parsing JUnit XML reports..."
          python3 - <<EOF
          import os
          import xml.etree.ElementTree as ET
      
          report_dir = './reports'
          total_tests = 0
          total_failures = 0
          total_skipped = 0
          test_results = []
      
          for filename in os.listdir(report_dir):
              if filename.endswith('.xml'):
                  filepath = os.path.join(report_dir, filename)
                  tree = ET.parse(filepath)
                  root = tree.getroot()
                  suites = root.findall('testsuite') if root.tag == 'testsuites' else [root]
      
                  for suite in suites:
                      total_tests += int(suite.attrib.get('tests', 0))
                      total_failures += int(suite.attrib.get('failures', 0))
                      total_skipped += int(suite.attrib.get('skipped', 0))
      
                      for case in suite.findall('testcase'):
                          classname = case.attrib.get('classname', '')
                          name = case.attrib.get('name', '')
                          status = 'PASSED'
                          if case.find('failure') is not None:
                              status = 'FAILED'
                          elif case.find('skipped') is not None:
                              status = 'SKIPPED'
                          test_results.append((classname, name, status))
      
          print("â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”")
          print("â”‚         Test Result        â”‚   Count    â”‚")
          print("â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤")
          print(f"â”‚ Total Tests                â”‚ {total_tests:<10} â”‚")
          print(f"â”‚ Passed                     â”‚ {total_tests - total_failures - total_skipped:<10} â”‚")
          print(f"â”‚ Failed                     â”‚ {total_failures:<10} â”‚")
          print(f"â”‚ Skipped                    â”‚ {total_skipped:<10} â”‚")
          print("â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜\\n")
      
          print("Individual Test Results:")
          print("â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”")
          print("â”‚ Class Name                                   â”‚ Test Name                      â”‚ Status   â”‚")
          print("â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤")
          for classname, name, status in test_results:
              print(f"â”‚ {classname:<44} â”‚ {name:<30} â”‚ {status:<8} â”‚")
          print("â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜")
          EOF

      - name: Upload Test Results
        uses: actions/upload-artifact@v4
        with:
          name: readyapi-results
          path: ./reports

      - name: Publish Test Report
        uses: dorny/test-reporter@v1
        if: always()
        with:
          name: ReadyAPI Test Results
          path: ./reports/*.xml
          reporter: java-junit
